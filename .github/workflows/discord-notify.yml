name: Notify Discord

on:
  push:
    branches: [ "main" ]
  pull_request:
    types: [ opened, closed ]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Decide message
        id: msg
        run: |
          echo "CONTENT=" >> $GITHUB_OUTPUT

          if [ "${{ github.event_name }}" = "push" ]; then
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            AUTHOR="${{ github.actor }}"
            BRANCH="${{ github.ref_name }}"
            URL="${{ github.event.head_commit.url }}"
            echo "CONTENT=âœ… **Push to \`${BRANCH}\`** by **${AUTHOR}**\n${COMMIT_MSG}\n${URL}" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.action }}" = "opened" ]; then
            TITLE="${{ github.event.pull_request.title }}"
            AUTHOR="${{ github.actor }}"
            URL="${{ github.event.pull_request.html_url }}"
            BASE="${{ github.event.pull_request.base.ref }}"
            HEAD="${{ github.event.pull_request.head.ref }}"
            echo "CONTENT=ðŸ†• **PR Opened** by **${AUTHOR}**\n**${TITLE}**\n\`${HEAD}\` â†’ \`${BASE}\`\n${URL}" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            TITLE="${{ github.event.pull_request.title }}"
            AUTHOR="${{ github.actor }}"
            URL="${{ github.event.pull_request.html_url }}"
            BASE="${{ github.event.pull_request.base.ref }}"
            HEAD="${{ github.event.pull_request.head.ref }}"
            echo "CONTENT=ðŸŽ‰ **PR Merged** by **${AUTHOR}**\n**${TITLE}**\n\`${HEAD}\` â†’ \`${BASE}\`\n${URL}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # PR closed but not merged -> do nothing
          echo "CONTENT=" >> $GITHUB_OUTPUT

      - name: Send to Discord
        if: steps.msg.outputs.CONTENT != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          CONTENT: ${{ steps.msg.outputs.CONTENT }}
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\":\"${CONTENT}\"}" \
               "$DISCORD_WEBHOOK_URL"
